<div class="player-card" onclick="this.classList.toggle('expanded')">
  {% assign player_name = include.extra.name | default: include.player.general.name %}
  {% if player_name == nil or player_name == "" %}
    {% assign name_parts = include.extra.id | split: "_" %}
    {% capture player_name %}
      {% for part in name_parts %}{{ part | capitalize }} {% endfor %}
    {% endcapture %}
    {% assign player_name = player_name | strip %}
  {% endif %}

  {% assign ul = include.player.sources["Unity League"] %}
  {% assign mtg_elo = include.player.sources["MTG Elo Project"] %}

  {% assign player_photo = include.extra.photo | default: include.player.general.photo %}
  {% if player_photo == nil or player_photo == "" %}
    {% assign player_photo = '/assets/images/players/placeholder.png' %}
  {% endif %}
  {% assign player_hometown = include.player.general.hometown | default: include.extra.hometown %}
  {% assign player_age = include.player.general.age | default: include.extra.age %}
  {% assign player_pronouns = include.extra.pronouns | default: include.player.general.pronouns %}
  {% assign player_country = include.extra.country | default: include.player.general.country %}
  {% assign player_bio = include.player.general.bio | default: include.extra.bio %}
  {% assign total_winrate = include.player.general["win rate"] %}

  {% assign player_facebook = include.extra.social_media.facebook | default: include.player.general.facebook %}
  {% assign player_twitch = include.extra.social_media.twitch | default: include.player.general.twitch %}
  {% assign player_youtube = include.extra.social_media.youtube | default: include.player.general.youtube %}
  {% assign player_twitter = include.extra.social_media.twitter | default: include.player.general.twitter %}
  {% assign player_bluesky = include.extra.social_media.bluesky | default: include.player.general.bluesky %}
  {% assign player_instagram = include.extra.social_media.instagram | default: include.player.general.instagram %}

  {% comment %}
  Helper to determine MTGA rank class based on the rank string
  {% endcomment %}
  {% assign mtga_rank_class = "" %}
  {% assign constructed_rank = include.player.general.mtga_rank.constructed %}
  {% if constructed_rank %}
    {% if constructed_rank contains "Bronze" %}
      {% assign mtga_rank_class = "mtga-rank-bronze" %}
    {% elsif constructed_rank contains "Silver" %}
      {% assign mtga_rank_class = "mtga-rank-silver" %}
    {% elsif constructed_rank contains "Gold" %}
      {% assign mtga_rank_class = "mtga-rank-gold" %}
    {% elsif constructed_rank contains "Platinum" %}
      {% assign mtga_rank_class = "mtga-rank-platinum" %}
    {% elsif constructed_rank contains "Diamond" %}
      {% assign mtga_rank_class = "mtga-rank-diamond" %}
    {% elsif constructed_rank contains "Mythic" %}
      {% assign mtga_rank_class = "mtga-rank-mythic" %}
    {% endif %}
  {% endif %}

  {% assign mtga_limited_rank_class = "" %}
  {% assign limited_rank = include.player.general.mtga_rank.limited %}
  {% if limited_rank %}
    {% if limited_rank contains "Bronze" %}
      {% assign mtga_limited_rank_class = "mtga-rank-bronze" %}
    {% elsif limited_rank contains "Silver" %}
      {% assign mtga_limited_rank_class = "mtga-rank-silver" %}
    {% elsif limited_rank contains "Gold" %}
      {% assign mtga_limited_rank_class = "mtga-rank-gold" %}
    {% elsif limited_rank contains "Platinum" %}
      {% assign mtga_limited_rank_class = "mtga-rank-platinum" %}
    {% elsif limited_rank contains "Diamond" %}
      {% assign mtga_limited_rank_class = "mtga-rank-diamond" %}
    {% elsif limited_rank contains "Mythic" %}
      {% assign mtga_limited_rank_class = "mtga-rank-mythic" %}
    {% endif %}
  {% endif %}

  <!-- Compact Tile View -->
  <div class="player-card-tile">
    <div class="tile-photo-container">
      <img src="{{ player_photo }}" alt="{{ player_name }}" class="tile-photo">
    </div>
    <div class="tile-info">
      <div class="tile-name">{{ player_name }}</div>
      <div class="tile-stats-row">
        <div class="tile-stat">
          <span class="tile-stat-label">ELO</span>
          <span class="tile-stat-value {% unless mtg_elo %}missing{% endunless %}">{% if mtg_elo %}{{ mtg_elo.data.current_rating }}{% else %}n/a{% endif %}</span>
        </div>
        <div class="tile-stat">
          <span class="tile-stat-label">DE</span>
          <span class="tile-stat-value {% unless ul %}missing{% endunless %}">{% if ul %}#{{ ul.data["rank germany"] }}{% else %}n/a{% endif %}</span>
        </div>
        <div class="tile-stat">
          <span class="tile-stat-label">EU</span>
          <span class="tile-stat-value {% unless ul %}missing{% endunless %}">{% if ul %}#{{ ul.data["rank europe"] }}{% else %}n/a{% endif %}</span>
        </div>
        <div class="tile-stat">
          <span class="tile-stat-label">
            Winrate
            {% if total_winrate %}
            <span class="iconify info-icon" data-icon="mdi-information-slab-circle-outline" title="Win rate based on wins vs. sum of losses and draws aggregated from all sources"></span>
            {% endif %}
          </span>
          <span class="tile-stat-value {% unless total_winrate %}missing{% endunless %}">{% if total_winrate %}{{ total_winrate }}{% else %}n/a{% endif %}</span>
        </div>
        <div class="tile-stat">
          <span class="tile-stat-label">MTGA Rank</span>
          <span class="tile-stat-value mtga-rank {{ mtga_rank_class }} {% unless include.player.general.mtga_rank.constructed %}missing{% endunless %}">{% if include.player.general.mtga_rank.constructed %}{{ include.player.general.mtga_rank.constructed }}{% else %}n/a{% endif %}</span>
        </div>
      </div>
    </div>
    <div class="tile-expand-icon">
      <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </div>
  </div>

  <!-- Expanded Details View -->
  <div class="player-card-expanded-content">
    <div class="player-card-header">
      <img src="{{ player_photo }}" alt="{{ player_name }}" class="player-photo">
      <div class="player-main-info">
        <div class="player-info-content">
          <div class="player-primary-details">
            <div class="player-details-row">
              <ul class="player-general-data">
                {% if player_age %}
                <li><strong>Age:</strong> {{ player_age }}</li>
                {% endif %}
                {% if player_pronouns %}
                <li><strong>Pronouns:</strong> {{ player_pronouns }}</li>
                {% endif %}
                {% if player_hometown %}
                <li><strong>Hometown:</strong> {{ player_hometown }}</li>
                {% endif %}
              </ul>
              {% if player_country %}
              <div class="player-country-flag">
                <img src="https://flagcdn.com/w40/{{ player_country | downcase }}.png"
                     srcset="https://flagcdn.com/w80/{{ player_country | downcase }}.png 2x"
                     alt="{{ player_country }}"
                     title="{{ player_country }}">
              </div>
              {% endif %}
            </div>
            {% if player_twitter or player_bluesky or player_twitch or player_youtube or player_instagram or player_facebook %}
            <div class="player-social" onclick="event.stopPropagation()">
              {% if player_twitter %}
              <a href="https://twitter.com/{{ player_twitter }}" target="_blank" title="Twitter"><img src="https://simpleicons.org/icons/x.svg" alt="Twitter" class="social-icon"></a>
              {% endif %}
              {% if player_bluesky %}
              <a href="https://bsky.app/profile/{{ player_bluesky }}" target="_blank" title="Bluesky"><img src="https://simpleicons.org/icons/bluesky.svg" alt="Bluesky" class="social-icon"></a>
              {% endif %}
              {% if player_facebook %}
              <a href="https://facebook.com/{{ player_facebook }}" target="_blank" title="Facebook"><img src="https://simpleicons.org/icons/facebook.svg" alt="Facebook" class="social-icon"></a>
              {% endif %}
              {% if player_twitch %}
              <a href="https://twitch.tv/{{ player_twitch }}" target="_blank" title="Twitch"><img src="https://simpleicons.org/icons/twitch.svg" alt="Twitch" class="social-icon"></a>
              {% endif %}
              {% if player_youtube %}
              {% assign yt_handle = player_youtube %}
              {% unless yt_handle contains '@' %}
                {% assign yt_handle = '@' | append: yt_handle %}
              {% endunless %}
              <a href="https://youtube.com/{{ yt_handle }}" target="_blank" title="YouTube"><img src="https://simpleicons.org/icons/youtube.svg" alt="YouTube" class="social-icon"></a>
              {% endif %}
              {% if player_instagram %}
              <a href="https://instagram.com/{{ player_instagram }}" target="_blank" title="Instagram"><img src="https://simpleicons.org/icons/instagram.svg" alt="Instagram" class="social-icon"></a>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% if player_bio %}
          <div class="player-bio-container">
            <p class="player-bio">{{ player_bio }}</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="player-stats" onclick="event.stopPropagation()">
      {% if ul or mtg_elo %}
      <div class="stat-section">
        <h3>Ranks & Ratings</h3>
        <div class="stat-grid">
          {% if ul %}
          <a href="{{ ul.url }}" target="_blank" class="stat-item linked-stat">
            <span class="stat-label">Unity League Rank DE</span>
            <span class="stat-value">{{ ul.data["rank germany"] }}</span>
          </a>
          <a href="{{ ul.url }}" target="_blank" class="stat-item linked-stat">
            <span class="stat-label">Unity League Rank EU</span>
            <span class="stat-value">{{ ul.data["rank europe"] }}</span>
          </a>
          <a href="{{ ul.url }}" target="_blank" class="stat-item linked-stat">
            <span class="stat-label">Unity League Points</span>
            <span class="stat-value">{{ ul.data["rank points"] }}</span>
          </a>
          {% endif %}

          {% if mtg_elo %}
          <a href="{{ mtg_elo.url }}" target="_blank" class="stat-item linked-stat">
            <span class="stat-label">MTG Elo Rating</span>
            <span class="stat-value">{{ mtg_elo.data.current_rating }}</span>
          </a>
          {% endif %}

          {% assign untapped = include.player.sources["Untapped.gg"] %}
          {% if untapped and untapped.data and untapped.data.mtga_rank and untapped.data.mtga_rank.constructed %}
          <a href="{{ untapped.url }}" target="_blank" class="stat-item linked-stat">
            <span class="stat-label">MTGA Rank Constructed</span>
            <span class="stat-value mtga-rank {{ mtga_rank_class }}">{{ untapped.data.mtga_rank.constructed }}</span>
          </a>
          {% endif %}
          {% if untapped and untapped.data and untapped.data.mtga_rank and untapped.data.mtga_rank.limited %}
          <a href="{{ untapped.url }}" target="_blank" class="stat-item linked-stat">
            <span class="stat-label">MTGA Rank Limited</span>
            <span class="stat-value mtga-rank {{ mtga_limited_rank_class }}">{{ untapped.data.mtga_rank.limited }}</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% assign melee = include.player.sources["Melee"] %}
      {% assign topdeck = include.player.sources["Topdeck"] %}
      {% assign untapped = include.player.sources["Untapped.gg"] %}

      {% if mtg_elo.data.record or ul.data.record or ul.data["win rate"] or melee.data.record or melee.data["win rate"] or topdeck.data.record or topdeck.data["win rate"] or untapped.data.mtga_rank %}
      <div class="tournament-record">
        <h3>Tournament Record</h3>
        <div class="record-grid">
          {% if ul.data.record %}
          <a href="{{ ul.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">Unity League Record</span>
            {{ ul.data.record }}
          </a>
          {% endif %}

          {% if ul.data["win rate"] %}
          <a href="{{ ul.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">
              Unity League Winrate
              <span class="iconify info-icon" data-icon="mdi-information-slab-circle-outline" title="Win rate based on achieved match points, i.e. counting draws as 1/3 of a win"></span>
            </span>
            {{ ul.data["win rate"] }}
          </a>
          {% endif %}

          {% if mtg_elo.data.record %}
          <a href="{{ mtg_elo.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">MTG Elo Record</span>
            {{ mtg_elo.data.record }}
          </a>
          {% endif %}

          {% if mtg_elo.data["win rate"] %}
          <a href="{{ mtg_elo.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">
              MTG Elo Winrate
              <span class="iconify info-icon" data-icon="mdi-information-slab-circle-outline" title="Win rate based on wins vs. sum of losses and draws"></span>
            </span>
            {{ mtg_elo.data["win rate"] }}
          </a>
          {% endif %}

          {% if melee.data.record %}
          <a href="{{ melee.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">Melee Record</span>
            {{ melee.data.record }}
          </a>
          {% endif %}

          {% if melee.data["win rate"] %}
          <a href="{{ melee.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">
              Melee Winrate
              <span class="iconify info-icon" data-icon="mdi-information-slab-circle-outline" title="Win rate based on wins vs. sum of losses and draws"></span>
            </span>
            {{ melee.data["win rate"] }}
          </a>
          {% endif %}

          {% if topdeck.data.record %}
          <a href="{{ topdeck.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">Topdeck Record</span>
            {{ topdeck.data.record }}
          </a>
          {% endif %}

          {% if topdeck.data["win rate"] %}
          <a href="{{ topdeck.url }}" target="_blank" class="record-item linked-record">
            <span class="record-label">
              Topdeck Winrate
              <span class="iconify info-icon" data-icon="mdi-information-slab-circle-outline" title="Win rate based on wins vs. sum of losses and draws"></span>
            </span>
            {{ topdeck.data["win rate"] }}
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
